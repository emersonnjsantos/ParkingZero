syntax = "proto3";

package parking;

option go_package = "github.com/emersonnjsantos/ParkingZero/pkg/pb";

// O Contrato (Definição do Protobuf)
// Objetivo: Definir a "língua" que o App e a API vão falar.

service ParkingService {
  // Busca de Garagens
  rpc SearchGarages (SearchRequest) returns (SearchResponse);
  rpc GetGarage (GetGarageRequest) returns (Garage);
  
  // Sistema de Reservas
  rpc CreateReservation (CreateReservationRequest) returns (Reservation);
  rpc ListReservations (ListReservationsRequest) returns (ListReservationsResponse);
  rpc CancelReservation (CancelReservationRequest) returns (CancelReservationResponse);
  
  // Sistema de Entrada/Saída (Latência Crítica - B+Tree Local)
  rpc RecordVehicleEntry (VehicleEntryRequest) returns (VehicleEntryResponse);
  rpc RecordVehicleExit (VehicleExitRequest) returns (VehicleExitResponse);
  rpc GetActiveVehicles (GetActiveVehiclesRequest) returns (GetActiveVehiclesResponse);
  rpc GetVehicleEntry (GetVehicleEntryRequest) returns (VehicleEntry);
}

// === Busca de Garagens ===

message SearchRequest {
  double latitude = 1;
  double longitude = 2;
  int32 radius_meters = 3;
}

message SearchResponse {
  repeated Garage garages = 1;
}

message GetGarageRequest {
  string garage_id = 1;
}

message Garage {
  string id = 1;
  string name = 2;
  double base_price = 3;
  double latitude = 4;
  double longitude = 5;
  string image_url = 6;
  repeated Campaign campaigns = 7;
  string address = 8;
  string phone = 9;
  int32 total_spots = 10;
  int32 available_spots = 11;
  repeated string amenities = 12;  // WiFi, EV Charging, etc.
}

message Campaign {
  string partner_name = 1;
  string discount_rule = 2;
}

// === Sistema de Reservas ===

message CreateReservationRequest {
  string user_id = 1;
  string garage_id = 2;
  int64 start_time = 3;   // Unix timestamp (segundos)
  int64 end_time = 4;     // Unix timestamp (segundos)
  string vehicle_plate = 5;
}

message Reservation {
  string id = 1;
  string user_id = 2;
  string garage_id = 3;
  string garage_name = 4;
  int64 start_time = 5;
  int64 end_time = 6;
  string vehicle_plate = 7;
  double total_price = 8;
  ReservationStatus status = 9;
  int64 created_at = 10;
}

enum ReservationStatus {
  RESERVATION_STATUS_UNSPECIFIED = 0;
  PENDING = 1;
  ACTIVE = 2;
  COMPLETED = 3;
  CANCELLED = 4;
}

message ListReservationsRequest {
  string user_id = 1;
  ReservationStatus status_filter = 2;  // Opcional
}

message ListReservationsResponse {
  repeated Reservation reservations = 1;
}

message CancelReservationRequest {
  string reservation_id = 1;
  string user_id = 2;  // Para validação de ownership
}

message CancelReservationResponse {
  bool success = 1;
  string message = 2;
}

// === Sistema de Entrada/Saída de Veículos ===

message VehicleEntryRequest {
  string garage_id = 1;
  string vehicle_plate = 2;
  int64 entry_time = 3;   // Unix timestamp (segundos)
  string user_id = 4;      // Opcional: ID do usuário (se vinculado a reserva)
}

message VehicleEntryResponse {
  string entry_id = 1;     // ID único da entrada (garage_id|plate)
  bool success = 2;
  string message = 3;
  int64 entry_time = 4;    // Timestamp da entrada registrada
}

message VehicleExitRequest {
  string garage_id = 1;
  string vehicle_plate = 2;
  int64 exit_time = 3;     // Unix timestamp (segundos)
}

message VehicleExitResponse {
  string entry_id = 1;
  double total_amount = 2;      // Valor total a pagar
  int64 duration_seconds = 3;   // Tempo de permanência
  int64 entry_time = 4;         // Quando entrou
  int64 exit_time = 5;          // Quando saiu
  bool success = 6;
  string message = 7;
}

message VehicleEntry {
  string id = 1;                 // Chave composta: garage_id|vehicle_plate
  string garage_id = 2;
  string vehicle_plate = 3;
  int64 entry_time = 4;
  int64 exit_time = 5;           // 0 se ainda estacionado
  double amount_paid = 6;
  VehicleStatus status = 7;
  string user_id = 8;            // Opcional: vinculado a reserva
}

enum VehicleStatus {
  VEHICLE_STATUS_UNSPECIFIED = 0;
  PARKED = 1;                    // Estacionado (ativo)
  EXITED = 2;                    // Saiu (finalizado)
}

message GetActiveVehiclesRequest {
  string garage_id = 1;
}

message GetActiveVehiclesResponse {
  repeated VehicleEntry vehicles = 1;
  int32 total_active = 2;        // Total de veículos atualmente estacionados
}

message GetVehicleEntryRequest {
  string garage_id = 1;
  string vehicle_plate = 2;
}
